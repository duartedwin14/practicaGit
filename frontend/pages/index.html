<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi App - Login / Register</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .card { border: 1px solid #ddd; padding: 16px; border-radius: 8px; max-width: 420px; margin: 12px auto; }
    input, button { width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box;}
    .flex { display:flex; gap: 12px; justify-content: center; margin-top: 12px; }
  </style>
</head>
<body>
  <h1>Mi App - Registro / Login</h1>

  <div class="card" id="registerCard">
    <h2>Registrar</h2>
    <form id="formRegister">
      <input type="text" id="r_nombre" placeholder="Nombre" required />
      <input type="email" id="r_email" placeholder="Email" required />
      <input type="password" id="r_password" placeholder="Contraseña" required />
      <!-- Opcional: seleccionar role (solo admin puede usar) -->
      <select id="r_role">
        <option value="usuario" selected>Usuario</option>
        <option value="admin">Admin</option>
      </select>
      <button type="submit">Registrar</button>
    </form>
    <div id="registerMessage"></div>
  </div>

  <div class="card" id="loginCard">
    <h2>Iniciar sesión</h2>
    <form id="formLogin">
      <input type="email" id="l_email" placeholder="Email" required />
      <input type="password" id="l_password" placeholder="Contraseña" required />
      <button type="submit">Iniciar sesión</button>
    </form>
    <div id="loginMessage"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000/api';

    // Registro
    document.getElementById('formRegister').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nombre = document.getElementById('r_nombre').value.trim();
      const email = document.getElementById('r_email').value.trim();
      const password = document.getElementById('r_password').value;
      const role = document.getElementById('r_role').value;

      try {
        const res = await fetch(`${API_BASE}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre, email, password, role })
        });
        const data = await res.json();
        document.getElementById('registerMessage').innerText = data.message || JSON.stringify(data);
      } catch (err) {
        document.getElementById('registerMessage').innerText = 'Error al registrar';
        console.error(err);
      }
    });

    // Login
    document.getElementById('formLogin').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('l_email').value.trim();
      const password = document.getElementById('l_password').value;

      try {
        const res = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!res.ok) {
          document.getElementById('loginMessage').innerText = data.message || 'Error al iniciar sesión';
          return;
        }

        // guardar token y role
        localStorage.setItem('token', data.token);
        localStorage.setItem('role', data.role);
        localStorage.setItem('nombre', data.nombre || '');

        // redirigir según role
        if (data.role === 'admin') {
          window.location.href = '/pages/admin.html';
        } else {
          window.location.href = '/pages/usuario.html';
        }
      } catch (err) {
        document.getElementById('loginMessage').innerText = 'Error al iniciar sesión';
        console.error(err);
      }
    });

    // si ya existe token, redirigir automáticamente
    (function autoRedirect() {
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('role');
      if (token && role) {
        if (role === 'admin') window.location.href = '/pages/admin.html';
        else window.location.href = '/pages/usuario.html';
      }
    })();
  </script>
</body>
</html>
